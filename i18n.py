import os

_DEFAULT_LANG = 'en'
_DEFAULT_LANG_FILE = os.path.join(os.path.dirname(__file__), 'language.txt')


def _load_lang_from_file(path: str) -> str:
    try:
        with open(path, encoding='utf-8') as f:
            return f.read().strip() or _DEFAULT_LANG
    except OSError:
        return _DEFAULT_LANG


LANG = _load_lang_from_file(_DEFAULT_LANG_FILE)


def set_language(lang: str) -> None:
    global LANG
    LANG = lang


def set_language_from_file(path: str = _DEFAULT_LANG_FILE) -> None:
    set_language(_load_lang_from_file(path))

_STRINGS = {
    'en': {
        'warning': 'Warning',
        'error': 'Error',
        'start_over': 'Start Over',
        'reset_warning': 'All progress will be lost.\nRestart from the beginning?',
        'invalid_start': 'Invalid start branch.',
        'exit': 'Exit',
        'missing_target': 'Target branch does not exist: {id}',
        'select_novel': 'Select Novel File',
        'parse_error': 'Parse Error',
        'read_error': 'An error occurred while reading the file:\n{err}',
        'file_not_found': 'File not found: {path}',
        'update_title': 'Update',
        'update_available': '{app} {ver} is available. Update now?',
        'update_started': 'Installer has been launched.',
        'no_content': '(no content)',
        'input_values_required': 'Please enter variable, operator, and value.',
        'input_var_init_required': 'Please enter variable name and initial value.',
        'invalid_initial_value': 'Initial value must be a number or true/false.',
        'input_button_text': 'Please enter button text.',
        'select_target_branch': 'Please select a target branch ID.',
        'preview_apply': 'Apply Preview',
        'preview_apply_prompt': 'Changes in preview have not been applied. Apply now?',
        'chapter_id_required': 'Chapter ID cannot be empty.',
        'chapter_id_exists': 'Chapter ID already exists: {id}',
        'branch_id_required': 'Branch ID cannot be empty.',
        'branch_id_exists': 'Branch ID already exists: {id}',
        'at_least_one_chapter': 'At least one chapter is required.',
        'confirm_delete': 'Confirm Delete',
        'delete_chapter_prompt': "Delete chapter '{id}'?",
        'at_least_one_branch': 'Each chapter must have at least one branch.',
        'delete_branch_prompt': "Delete branch '{id}'?",
        'variable_name_exists': 'Variable name already exists.',
        'delete_variable_prompt': "Delete variable '{name}'?",
        'find_title': 'Find',
        'find_no_results': 'No results found.',
        'validation_title': 'Validation',
        'validation_ok': 'No issues.',
        'validation_result_title': 'Validation Results',
        'open_file_error': 'Failed to open file:\n{err}',
        'save_error': 'Failed to save:\n{err}',
        'save_title': 'Save',
        'save_done': 'Save complete.',
        'unsaved_changes_title': 'Unsaved Changes',
        'unsaved_changes_prompt': 'You have unsaved changes. Save them?',
        'condition_action_title': 'Condition/Action',
        'variable': 'Variable',
        'operator': 'Operator',
        'value': 'Value',
        'operator_help': 'Operator table:\n=  : assign\n+= : add and assign, -= : subtract and assign, *= : multiply and assign, /= : divide and assign\n//= : integer division, %= : modulo, **= : exponentiation\n== : equal, != : not equal, > : greater, < : less, >= : greater or equal, <= : less or equal',
        'ok': 'OK',
        'cancel': 'Cancel',
        'add_variable': 'Add Variable',
        'edit_variable': 'Edit Variable',
        'variable_name': 'Variable Name',
        'initial_value': 'Initial Value',
        'edit_conditions': 'Edit Conditions/Actions',
        'add': 'Add',
        'edit': 'Edit',
        'delete': 'Delete',
        'button_text': 'Button Text',
        'target_branch_id': 'Target Branch ID',
        'condition_action_expr': 'Condition/Action Expression',
        'edit_ellipsis': 'Edit...',
        'add_choice': 'Add Choice',
        'edit_choice': 'Edit Choice',
        'new': 'New',
        'open': 'Open...',
        'save': 'Save',
        'save_as': 'Save As...',
        'file_menu': 'File',
        'add_chapter': 'Add Chapter',
        'delete_chapter': 'Delete Chapter',
        'find_replace': 'Find/Replace',
        'edit_menu': 'Edit',
        'story_info': 'Story Info',
        'title_label': 'Title(@title)',
        'start_branch_label': 'Start Branch(@start)',
        'ending_text_label': 'Ending Text(@ending)',
        'show_disabled_choices': 'Show disabled choices',
        'variable_list': 'Variable List',
        'chapter_list': 'Chapter List',
        'branch_list': 'Branch List',
        'up': 'Up',
        'down': 'Down',
        'edit_branch_tab': 'Edit Branch',
        'chapter_id': 'Chapter ID',
        'chapter_title': 'Chapter Title',
        'branch_id': 'Branch ID',
        'branch_title': 'Branch Title',
        'body_label': 'Body (blank line separates paragraphs)',
        'choices_section': 'Choices (buttons)',
        'preview_tab': 'Generated Preview (.bnov)',
        'validate_story': 'Validate',
        'analyze_loops': 'Analyze Infinite Loops',
        'apply_preview_btn': 'Apply Preview',
        'refresh_preview_btn': 'Refresh Preview',
        'run_preview_btn': 'Run Preview',
        'search_scope': 'Search Scope',
        'this_branch': 'This Branch',
        'entire_project': 'Entire Project',
        'find_string': 'Find Text',
        'replace_string': 'Replace With',
        'previous': 'Previous',
        'next': 'Next',
        'replace': 'Replace',
        'story_title_empty': 'Story title is empty.',
        'branch_id_empty': 'Branch ID is empty: internal key={id}',
        'branch_id_mismatch': 'Internal key and branch ID do not match: {id} != {branch_id}',
        'warn_choice_target_missing': "[{id}] Choice target missing: '{text}' -> {target}",
        'warn_chapter_no_branches': "Chapter '{id}' has no branches.",
        'errors_label': 'Errors:',
        'warnings_label': 'Warnings:',
        'open_title': 'Open',
        'save_as_title': 'Save As',
        'loop_analysis_title': 'Infinite Loop Analysis',
        'uncertain_complex': 'Uncertain (complex expression)',
        'complex_expr': '(complex expression)',
        'cond_none': '(no condition)',
        'always_open': 'Always open',
        'possible': 'Possible',
        'impossible': 'Impossible',
        'no_exit_path': 'No external escape paths',
        'more_items': '... (+{n} more)',
        'loop_summary_heading': 'Infinite Loop Analysis Summary',
        'loop_summary_counts': '- Definite: {definite}, Witnessed: {witnessed}, Needs Review (Possible): {possible}',
        'loop_definite_header': '[Definite Infinite Loops] Fix required',
        'loop_nodes_line': '{i}. Loop nodes {count}',
        'loop_path_summary_line': '   Path summary: {path}',
        'loop_no_exit': '   Exit possibility: no external escape path (all nodes always move internally)',
        'loop_definite_action': '   Action: add choices leading outside or add escape conditions (e.g., variable decrease + threshold guard)',
        'loop_witnessed_header': '[Witnessed Infinite Loops] Repeated in actual execution',
        'loop_example_path': '   Example execution path (partial):',
        'loop_more_steps': '     ... (+{count} steps)',
        'loop_exit_candidates': '   External exit candidates:',
        'loop_witnessed_action': '   Action: ensure the conditions of the above exit candidates can actually be met; adjust condition/action design if needed',
        'loop_possible_header': '[Potential Infinite Loops] Structural cycle, escape paths may exist',
        'loop_exit_summary': '   External exit summary:',
        'loop_possible_action': "   Action: If there are 'always open' or 'uncertain' edges, clarify their conditions. If only 'possible' edges exist, verify that their conditions can actually be satisfied",
        'definitions_heading': 'Definitions:',
        'definition_definite': '- Definite: Each node can always move internally, and no external escape is possible in any state',
        'definition_witnessed': '- Witnessed: Repeatedly reached by following internal transitions with actual values',
        'definition_possible': '- Possible: There is a cycle, but external escape may open depending on conditions',
        'close': 'Close',
    },
    'korean': {
        'warning': '경고',
        'error': '오류',
        'start_over': '처음부터',
        'reset_warning': '지금까지의 진행 상황이 사라집니다.\n처음부터 다시 시작하시겠습니까?',
        'invalid_start': '시작 분기가 유효하지 않습니다.',
        'exit': '나가기',
        'missing_target': '타겟 분기가 존재하지 않습니다: {id}',
        'select_novel': '소설 파일 선택',
        'parse_error': '파싱 오류',
        'read_error': '파일을 읽는 중 오류가 발생했습니다:\n{err}',
        'file_not_found': '파일을 찾을 수 없습니다: {path}',
        'update_title': '업데이트',
        'update_available': '{app} {ver} 버전이 있습니다. 지금 업데이트할까요?',
        'update_started': '설치 프로그램이 실행되었습니다.',
        'no_content': '(내용 없음)',
        'input_values_required': '변수, 연산자, 값을 모두 입력하세요.',
        'input_var_init_required': '변수명과 초기값을 입력하세요.',
        'invalid_initial_value': '초기값은 숫자 또는 true/false여야 합니다.',
        'input_button_text': '버튼 문구를 입력하세요.',
        'select_target_branch': '이동 타깃 분기 ID를 선택하세요.',
        'preview_apply': '미리보기 반영',
        'preview_apply_prompt': '미리보기에서 수정된 내용이 반영되지 않았습니다. 반영하시겠습니까?',
        'chapter_id_required': '챕터 ID는 비울 수 없습니다.',
        'chapter_id_exists': '이미 존재하는 챕터 ID입니다: {id}',
        'branch_id_required': '분기 ID는 비울 수 없습니다.',
        'branch_id_exists': '이미 존재하는 분기 ID입니다: {id}',
        'at_least_one_chapter': '최소 한 개의 챕터는 필요합니다.',
        'confirm_delete': '삭제 확인',
        'delete_chapter_prompt': "챕터 '{id}'를 삭제하시겠습니까?",
        'at_least_one_branch': '챕터에는 최소 한 개의 분기가 필요합니다.',
        'delete_branch_prompt': "분기 '{id}'를 삭제하시겠습니까?",
        'variable_name_exists': '이미 존재하는 변수명입니다.',
        'delete_variable_prompt': "변수 '{name}'를 삭제하시겠습니까?",
        'find_title': '찾기',
        'find_no_results': '결과가 없습니다.',
        'validation_title': '유효성 검사',
        'validation_ok': '문제 없음.',
        'validation_result_title': '유효성 검사 결과',
        'open_file_error': '파일을 열 수 없습니다:\n{err}',
        'save_error': '저장 실패:\n{err}',
        'save_title': '저장',
        'save_done': '저장 완료.',
        'unsaved_changes_title': '변경 내용',
        'unsaved_changes_prompt': '저장하지 않은 변경사항이 있습니다. 저장하시겠습니까?',
        'condition_action_title': '조건/행동',
        'variable': '변수',
        'operator': '연산자',
        'value': '값',
        'operator_help': '연산자 표:\n=  : 대입\n+= : 더해서 대입, -= : 빼서 대입, *= : 곱해서 대입, /= : 나누어 대입\n//= : 몫만 대입, %= : 나머지 대입, **= : 거듭제곱 대입\n== : 같음, != : 다름, > : 큼, < : 작음, >= : 크거나 같음, <= : 작거나 같음',
        'ok': '확인',
        'cancel': '취소',
        'add_variable': '변수 추가',
        'edit_variable': '변수 편집',
        'variable_name': '변수명',
        'initial_value': '초기값',
        'edit_conditions': '조건/행동 편집',
        'add': '추가',
        'edit': '편집',
        'delete': '삭제',
        'button_text': '버튼 문구',
        'target_branch_id': '이동 타깃 분기 ID',
        'condition_action_expr': '조건/행동식',
        'edit_ellipsis': '편집...',
        'add_choice': '선택지 추가',
        'edit_choice': '선택지 편집',
        'new': '새로 만들기',
        'open': '열기...',
        'save': '저장',
        'save_as': '다른 이름으로 저장...',
        'file_menu': '파일',
        'add_chapter': '챕터 추가',
        'delete_chapter': '챕터 삭제',
        'find_replace': '찾기/변경',
        'edit_menu': '편집',
        'story_info': '작품 정보',
        'title_label': '제목(@title)',
        'start_branch_label': '시작 분기(@start)',
        'ending_text_label': '엔딩 문구(@ending)',
        'show_disabled_choices': '비활성 선택지 표시',
        'variable_list': '변수 목록',
        'chapter_list': '챕터 목록',
        'branch_list': '분기 목록',
        'up': '위로',
        'down': '아래로',
        'edit_branch_tab': '분기 편집',
        'chapter_id': '챕터 ID',
        'chapter_title': '챕터 제목',
        'branch_id': '분기 ID',
        'branch_title': '분기 제목',
        'body_label': '본문(빈 줄로 문단 구분)',
        'choices_section': '선택지(버튼)',
        'preview_tab': '생성 미리보기(.bnov)',
        'validate_story': '유효성 검사',
        'analyze_loops': '무한 루프 분석',
        'apply_preview_btn': '미리보기 반영',
        'refresh_preview_btn': '미리보기 갱신',
        'run_preview_btn': '미리보기 실행',
        'search_scope': '찾기 범위',
        'this_branch': '이 분기',
        'entire_project': '프로젝트 전체',
        'find_string': '찾을 문자열',
        'replace_string': '바꿀 문자열',
        'previous': '이전',
        'next': '다음',
        'replace': '바꾸기',
        'story_title_empty': '작품 제목이 비어 있습니다.',
        'branch_id_empty': '분기 ID가 비어 있습니다: 내부키={id}',
        'branch_id_mismatch': '내부키와 분기 ID가 불일치합니다: {id} != {branch_id}',
        'warn_choice_target_missing': "[{id}] 선택지 타깃 미존재: '{text}' -> {target}",
        'warn_chapter_no_branches': "챕터 '{id}'에 분기가 없습니다.",
        'errors_label': '오류:',
        'warnings_label': '경고:',
        'open_title': '열기',
        'save_as_title': '다른 이름으로 저장',
        'loop_analysis_title': '무한 루프 분석',
        'uncertain_complex': '불확실(복잡식)',
        'complex_expr': '(복잡식)',
        'cond_none': '(조건 없음)',
        'always_open': '항상 열림',
        'possible': '가능',
        'impossible': '불가능',
        'no_exit_path': '외부 탈출 경로 없음',
        'more_items': '... (+{n}개 더 있음)',
        'loop_summary_heading': '무한 루프 진단 요약',
        'loop_summary_counts': '- 확정: {definite}개, 증거로 확인: {witnessed}개, 검토 필요(가능): {possible}개',
        'loop_definite_header': '[확정 무한 루프]  반드시 수정 필요',
        'loop_nodes_line': '{i}. 루프 노드 {count}개',
        'loop_path_summary_line': '   요약 경로: {path}',
        'loop_no_exit': '   탈출 가능성: 외부 탈출 경로 없음(모든 노드가 내부로 항상 이동)',
        'loop_definite_action': '   조치: 외부로 나가는 선택지 추가, 또는 내부 선택지에 탈출 조건(예: 변수 감소+임계 가드) 부여',
        'loop_witnessed_header': '[증거 경로로 확인된 무한 루프]  실제 실행으로 반복됨',
        'loop_example_path': '   예시 실행 경로(일부):',
        'loop_more_steps': '     ... (+{count} 단계)',
        'loop_exit_candidates': '   외부 탈출 후보:',
        'loop_witnessed_action': '   조치: 위 탈출 후보의 조건을 충족시킬 기회가 실제로 오는지 확인. 필요 시 조건/액션 설계 조정',
        'loop_possible_header': '[검토 필요(가능 무한 루프)]  구조상 순환, 탈출 경로는 있을 수 있음',
        'loop_exit_summary': '   외부 탈출 요약:',
        'loop_possible_action': "   조치: '항상 열림' 또는 '불확실' 엣지가 있다면 조건을 구체화. '가능'만 존재한다면 그 조건을 만족할 상태가 실제로 도달 가능한지 점검",
        'definitions_heading': '정의:',
        'definition_definite': '- 확정: 각 노드에서 내부 이동이 항상 가능하고, 외부 탈출은 어떤 상태에서도 불가능',
        'definition_witnessed': '- 증거: 실제 값으로 내부만 따라가 반복 도달 확인',
        'definition_possible': '- 가능: 순환은 있으나 외부 탈출이 조건에 따라 열릴 수 있음',
        'close': '닫기',
    },
}


def tr(key: str, **kwargs) -> str:
    table = _STRINGS.get(LANG, _STRINGS['en'])
    text = table.get(key, key)
    return text.format(**kwargs)
